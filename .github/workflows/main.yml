name: version 2.0.0
on:
  push:
    branches: [main]
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run tests
      run: flutter test
    
    - name: Analyze code
      run: flutter analyze

  build_android:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Android APK
      run: flutter build apk --release --dart-define=APP_ENV=production
    
    - name: Build Android App Bundle
      run: flutter build appbundle --release --dart-define=APP_ENV=production
    
    - name: Upload Android Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-builds
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
  create_release:
    needs: build_android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.3"

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release --dart-define=APP_ENV=production

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ“± Smart Text Thief ${{ steps.version.outputs.VERSION }}

            ### âœ¨ New Features
            - ğŸ” Advanced search functionality for subjects
            - ğŸ“§ Search by name, email, and student count
            - ğŸ¨ Improved UI/UX

            ### ğŸ› Bug Fixes
            - Performance improvements
            - Bug fixes

            ### ğŸ“¥ Download & Install
            1. Download the APK below
            2. Enable "Install from Unknown Sources"
            3. Install the app

            ---
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



# build_ios_appetize:
#   name: ğŸ Build iOS for Appetize
#   runs-on: macos-latest

#   steps:
#   - name: ğŸ”„ Checkout code
#     uses: actions/checkout@v4

#   - name: âš™ï¸ Setup Flutter
#     uses: subosito/flutter-action@v2
#     with:
#       flutter-version: '3.35.6'

#   - name: ğŸ“¦ Install dependencies
#     run: |
#       flutter pub get
#       cd ios
#       pod install

#   - name: ğŸ—ï¸ Build iOS for Simulator
#     run: flutter build ios --simulator --debug --no-codesign

#   - name: ğŸ“¦ Create iOS App Zip
#     run: |
#       cd build/ios/iphonesimulator
#       zip -r app.zip Runner.app

#   - name: ğŸ“¤ Upload to Appetize
#     run: |
#       curl "https://api.appetize.io/v1/apps" \
#         -F "file=@build/ios/iphonesimulator/app.zip" \
#         -F "platform=ios" \
#         -F "token=tok_7ucic4hz3p4ubtnufyjc6t6mzm"

#   - name: ğŸ”— Get App URL
#     run: |
#       echo "âœ… iOS App uploaded to Appetize!"
#       echo "ğŸŒ Check your dashboard: https://appetize.io/dashboard"
